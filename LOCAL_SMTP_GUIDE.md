# Локальный SMTP сервер (как в GoPhish)

## Описание

Проект теперь поддерживает встроенный локальный SMTP сервер, который работает без интернета, как в GoPhish. Все письма сохраняются локально в базе данных PostgreSQL.

## Как это работает

1. **Локальный SMTP сервер** запускается на порту `1025` (стандартный порт для локальных SMTP)
2. **Письма сохраняются** в таблицу `local_emails` в PostgreSQL
3. **Без интернета** - все работает полностью локально
4. **Просмотр писем** через API или веб-интерфейс

## Настройка

### 1. Включить локальный SMTP

Через UI (Settings → SMTP):
- Включите опцию "Use Local SMTP"
- Сохраните настройки

Или через переменную окружения:
```env
USE_LOCAL_SMTP=true
```

### 2. Автоматический запуск

Локальный SMTP сервер запускается автоматически при старте приложения, если в конфигурации включен `useLocalSmtp`.

### 3. Ручное управление

API endpoints для управления локальным SMTP:

```bash
# Запустить сервер
POST /api/email/local/start

# Остановить сервер
POST /api/email/local/stop

# Проверить статус
GET /api/email/local/status

# Просмотреть сохраненные письма
GET /api/email/local/emails?limit=50&offset=0

# Просмотреть конкретное письмо
GET /api/email/local/emails/:id

# Удалить письмо
DELETE /api/email/local/emails/:id

# Очистить все письма
DELETE /api/email/local/emails
```

## Использование

### Отправка писем

Когда локальный SMTP включен, все письма отправляются на `localhost:1025` и сохраняются в базе данных вместо реальной отправки.

### Просмотр писем

Все письма можно просмотреть через API или добавить веб-интерфейс для просмотра (как в GoPhish).

## Миграции

Выполните миграции для добавления поддержки локального SMTP:

```bash
# Основная миграция (если еще не выполнена)
psql $DATABASE_URL -f backend/migrations/001_initial_schema.sql

# Миграция для локального SMTP
psql $DATABASE_URL -f backend/migrations/002_add_local_smtp.sql
```

## Структура базы данных

### Таблица local_emails

```sql
CREATE TABLE local_emails (
    id UUID PRIMARY KEY,
    "from" TEXT NOT NULL,
    "to" TEXT[] NOT NULL,
    subject TEXT,
    text TEXT,
    html TEXT,
    headers JSONB,
    date TIMESTAMP,
    created_at TIMESTAMP
);
```

## Преимущества

✅ Работает без интернета  
✅ Все письма сохраняются локально  
✅ Безопасно для тестирования  
✅ Легко просматривать отправленные письма  
✅ Не требует внешних SMTP серверов  

## Пример использования

1. Включите локальный SMTP в настройках
2. Отправьте тестовое письмо
3. Письмо сохранится в базе данных
4. Просмотрите его через API: `GET /api/email/local/emails`

## Порты

- **HTTP API**: `4000` (по умолчанию)
- **Local SMTP**: `1025` (по умолчанию)

Можно изменить порт SMTP через переменную окружения `LOCAL_SMTP_PORT`.

